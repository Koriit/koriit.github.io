<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Lista płyt CD</title>
    <meta name="robots" content="noindex">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
<div class="container">
    <h1 class="mb-3">Lista płyt CD</h1>
    <p>Ta strona zawiera listę albumów, które chciałbym mieć. Nie jest nigdzie linkowana, więc proszę zachować adres w zakładkach.</p>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Lp.</th>
            <th>Zespół</th>
            <th>Album</th>
            <th>Posiadam?</th>
        </tr>
        </thead>
        <tbody id="album-table-body"></tbody>
    </table>
</div>
<div class="modal fade" id="copyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Skopiowano</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Dane zostały skopiowane do schowka.
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Album</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addForm">
          <div class="mb-3">
            <label for="bandInput" class="form-label">Zespół</label>
            <input type="text" class="form-control" id="bandInput" required>
          </div>
          <div class="mb-3">
            <label for="albumInput" class="form-label">Album</label>
            <input type="text" class="form-control" id="albumInput" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" form="addForm" class="btn btn-primary" id="saveAlbum">Add</button>
      </div>
    </div>
  </div>
</div>
<script src="albums.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>

const urlParams = new URLSearchParams(window.location.search);
const isAdmin = urlParams.has('admin');
let tbody;

function updateRanks() {
  albums.forEach((a, i) => a.rank = i + 1);
}

function renderTable() {
  tbody.innerHTML = '';
  updateRanks();
  albums.forEach((album, idx) => {
    const tr = document.createElement('tr');
    if (isAdmin) {
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${album.band}</td>
        <td><img src="${album.thumb}" alt="miniaturka" class="img-thumbnail me-2" style="width:50px;height:50px;">${album.album}</td>
        <td><input type="checkbox" class="owned-checkbox" data-index="${idx}" ${album.owned ? 'checked' : ''}></td>
        <td>
          <button class="btn btn-sm btn-secondary move-up" data-index="${idx}">&#8593;</button>
          <button class="btn btn-sm btn-secondary move-down" data-index="${idx}">&#8595;</button>
          <button class="btn btn-sm btn-secondary move-top" data-index="${idx}">&#8657;</button>
          <button class="btn btn-sm btn-secondary move-bottom" data-index="${idx}">&#8659;</button>
          <button class="btn btn-sm btn-danger delete-item" data-index="${idx}">&#10060;</button>
          <button class="btn btn-sm btn-secondary upload-thumb" data-index="${idx}">Thumb</button>
          <input type="file" accept="image/*" class="thumb-input d-none" data-index="${idx}">
        </td>
      `;
    } else {
      const ownedText = album.owned ? 'Tak' : 'Nie';
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${album.band}</td>
        <td><img src="${album.thumb}" alt="miniaturka" class="img-thumbnail me-2" style="width:50px;height:50px;">${album.album}</td>
        <td>${ownedText}</td>
      `;
    }
    tbody.appendChild(tr);
  });
}

window.addEventListener('DOMContentLoaded', () => {
  tbody = document.getElementById('album-table-body');
  const headerRow = document.querySelector('thead tr');
  if (isAdmin) {
    const th = document.createElement('th');
    th.textContent = 'Akcje';
    headerRow.appendChild(th);
  }
  renderTable();

  if (isAdmin) {
    Sortable.create(tbody, {
      animation: 150,
      onEnd: e => {
        const item = albums.splice(e.oldIndex, 1)[0];
        albums.splice(e.newIndex, 0, item);
        renderTable();
      }
    });

    tbody.addEventListener('click', e => {
      const index = parseInt(e.target.dataset.index);
      if (e.target.classList.contains('move-up') && index > 0) {
        [albums[index - 1], albums[index]] = [albums[index], albums[index - 1]];
        renderTable();
      } else if (e.target.classList.contains('move-down') && index < albums.length - 1) {
        [albums[index + 1], albums[index]] = [albums[index], albums[index + 1]];
        renderTable();
      } else if (e.target.classList.contains('move-top')) {
        const item = albums.splice(index, 1)[0];
        albums.unshift(item);
        renderTable();
      } else if (e.target.classList.contains('move-bottom')) {
        const item = albums.splice(index, 1)[0];
        albums.push(item);
        renderTable();
      } else if (e.target.classList.contains('delete-item')) {
        albums.splice(index, 1);
        renderTable();
      } else if (e.target.classList.contains('upload-thumb')) {
        e.target.parentElement.querySelector('.thumb-input').click();
      }
    });

    tbody.addEventListener('change', e => {
      if (e.target.classList.contains('owned-checkbox')) {
        const index = parseInt(e.target.dataset.index);
        albums[index].owned = e.target.checked;
      } else if (e.target.classList.contains('thumb-input')) {
        const idx = parseInt(e.target.dataset.index);
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = 50;
              canvas.height = 50;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, 50, 50);
              albums[idx].thumb = canvas.toDataURL('image/jpeg');
              renderTable();
            };
            img.src = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      }
    });

    const container = document.querySelector('.container');
    const table = container.querySelector('table');

    const btnGroup = document.createElement('div');
    btnGroup.className = 'mb-3';

    const addBtn = document.createElement('button');
    addBtn.className = 'btn btn-success me-2';
    addBtn.textContent = 'Add Album';
    btnGroup.appendChild(addBtn);

    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn btn-primary';
    exportBtn.textContent = 'Export JSON';
    btnGroup.appendChild(exportBtn);

    container.insertBefore(btnGroup, table);

    const addModalEl = document.getElementById('addModal');
    const addModal = bootstrap.Modal.getOrCreateInstance(addModalEl);
    const bandInput = document.getElementById('bandInput');
    const albumInput = document.getElementById('albumInput');

    addBtn.addEventListener('click', () => {
      bandInput.value = '';
      albumInput.value = '';
      addModal.show();
    });

    document.getElementById('addForm').addEventListener('submit', e => {
      e.preventDefault();
      const band = bandInput.value.trim();
      const albumName = albumInput.value.trim();
      if (!band || !albumName) return;
      albums.push({ rank: albums.length + 1, band, album: albumName, owned: false, thumb: '' });
      renderTable();
      addModal.hide();
    });

    exportBtn.addEventListener('click', () => {
      const jsContent = 'const albums = ' + JSON.stringify(albums, null, 2) + ';';
      navigator.clipboard.writeText(jsContent).then(() => {
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('copyModal'));
        modal.show();
      });
    });
  }
});
</script>
</body>
</html>
